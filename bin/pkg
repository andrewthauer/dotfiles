#!/usr/bin/env bash
# Summary:
#   Manage system packages

set -o errexit -o pipefail -o noclobber

DOTFILES_HOME="${DOTFILES_HOME:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." &>/dev/null && pwd)}"
PATH="${DOTFILES_HOME}/bin:${PATH}"

usage() {
  local cmd
  cmd="$(basename "$0")"
  echo "SUMMARY"
  echo "  Manage system packages"
  echo ""
  echo "USAGE: $cmd [flags] [command]"
  echo ""
  echo "COMMANDS"
  echo "  install, add     Installs package(s)"
  echo "  uninstall, rm    Uninstalls package(s)"
  echo "  exec, x          Execute a command"
  echo "  help             Prints this message"
  echo ""
  echo "FLAGS"
  echo "  --type, -t       Package manager (aur, apt, apt-repo, brew, cargo, dnf, nix-env, pacman, yum)"
  echo
  echo "EXAMPLES"
  echo "  $cmd install git zsh bash"
  echo "  $cmd install --type brew git"
  echo "  $cmd install --type aur google-chrome"
  echo "  $cmd install --type apt-repo --repo 'deb [trusted=yes] https://apt.fury.io/rsteube/ /' carapace-bin"
}

install_aur_helper() {
  local helper="${1:-paru}"

  echo "$helper not found, installing it..."

  # Ensure base-devel is installed (required for building AUR packages)
  if ! pacman -Qg base-devel &>/dev/null; then
    echo "Installing base-devel..."
    $sudo_cmd pacman -S --needed --noconfirm base-devel
  fi

  # Install AUR helper from AUR
  local temp_dir
  temp_dir=$(mktemp -d)
  trap 'rm -rf "$temp_dir"' EXIT

  echo "Cloning $helper from AUR..."
  git clone "https://aur.archlinux.org/$helper.git" "$temp_dir/$helper"

  echo "Building and installing $helper..."
  (cd "$temp_dir/$helper" && makepkg -si --noconfirm)

  rm -rf "$temp_dir"
  trap - EXIT

  echo "$helper installed successfully!"
}

install_apt_repo() {
  local repo_line=""
  local pkgs=()

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --repo)
        repo_line="$2"
        shift 2
        ;;
      *)
        pkgs+=("$1")
        shift
        ;;
    esac
  done

  # Auto-generate repo filename from first package name
  local repo_file="${pkgs[0]}.list"

  # Add the repository
  echo "${repo_line}" | $sudo_cmd tee /etc/apt/sources.list.d/"${repo_file}"

  # Update and install packages
  $sudo_cmd apt update -y -q

  # shellcheck disable=SC2068
  $sudo_cmd apt install -y ${pkgs[@]}
}

init_package_manager() {
  local pkg_mgr="$1"

  #
  # TODO: Validate if package manager command exists
  #

  # Skip package manager updates
  if [ "$SKIP_PACKAGE_MANAGER_UPDATE" == "true" ]; then
    return
  fi

  case ${pkg_mgr} in
    "apt") $sudo_cmd apt update -y -q ;;
    "apt-repo") ;;
    "dnf") ;;
    "yum") ;;
    "pacman") ;;
    "aur")
      if ! command -v paru &>/dev/null; then
        install_aur_helper "paru"
      fi
      ;;
    "brew")
      if ! command -v brew &>/dev/null; then
        # shellcheck disable=SC1091
        source "${DOTFILES_HOME}/modules/homebrew/.config/homebrew/shellenv.sh"
      fi
      ;;
    "cargo")
      if ! command -v cargo-binstall &>/dev/null; then
        echo "Installing cargo-binstall..."
        if [[ "$(uname)" == "Darwin" ]]; then
          brew install cargo-binstall
        else
          cargo install cargo-binstall
        fi
      fi
      ;;
    "nix")
      if ! command -v nix-env &>/dev/null; then
        # shellcheck disable=SC1091
        source "${DOTFILES_HOME}/modules/nix/.config/profile.d/nix.sh"
      fi
      ;;
    *) ;;
  esac
}

handle_brew_packages() {
  local operation="$1"
  shift
  local to_process=()

  # Get list of all installed packages once
  local installed_packages
  installed_packages=$(brew list --formula 2>/dev/null | tr '\n' ' ')

  for pkg in "$@"; do
    if [[ " $installed_packages " == *" $pkg "* ]]; then
      # Package is installed
      if [[ "$operation" == "uninstall" ]]; then
        to_process+=("$pkg")
      else
        echo "Package $pkg already installed"
      fi
    else
      # Package is not installed
      if [[ "$operation" == "install" ]]; then
        to_process+=("$pkg")
      else
        echo "Package $pkg not installed"
      fi
    fi
  done

  if [ ${#to_process[@]} -gt 0 ]; then
    brew "$operation" "${to_process[@]}"
  fi
}

install_package() {
  local pkgs=("$*")

  case ${pkg_mgr} in
    "apt")
      # shellcheck disable=SC2068
      $sudo_cmd apt install -y ${pkgs[@]}
      ;;
    "apt-repo")
      # shellcheck disable=SC2068
      install_apt_repo ${pkgs[@]}
      ;;
    "brew")
      # shellcheck disable=SC2068
      handle_brew_packages "install" ${pkgs[@]}
      ;;
    "cargo")
      # shellcheck disable=SC2068
      cargo binstall -y ${pkgs[@]}
      ;;
    "dnf")
      # shellcheck disable=SC2068
      $sudo_cmd dnf install -y ${pkgs[@]}
      ;;
    "nix-env")
      # shellcheck disable=SC2068
      for pkg in ${pkgs[@]}; do
        nix-env -iA nixpkgs."$pkg"
      done
      ;;
    "pacman")
      # shellcheck disable=SC2068
      $sudo_cmd pacman -S --needed --noconfirm ${pkgs[@]}
      ;;
    "aur")
      # DO NOT use sudo with paru - it handles privilege escalation itself
      # shellcheck disable=SC2068
      paru -S --needed --noconfirm ${pkgs[@]}
      ;;
    "yum")
      # shellcheck disable=SC2068
      $sudo_cmd yum install -y ${pkgs[@]}
      ;;
    *) ;;
  esac
}

uninstall_package() {
  local pkgs=("$*")

  case ${pkg_mgr} in
    "apt" | "apt-repo")
      # shellcheck disable=SC2068
      $sudo_cmd apt remove -y ${pkgs[@]}
      ;;
    "brew")
      # shellcheck disable=SC2068
      handle_brew_packages "uninstall" ${pkgs[@]}
      ;;
    "cargo")
      # shellcheck disable=SC2068
      cargo uninstall ${pkgs[@]}
      ;;
    "dnf")
      # shellcheck disable=SC2068
      $sudo_cmd dnf remove -y ${pkgs[@]}
      ;;
    "nix-env")
      # shellcheck disable=SC2068
      for pkg in ${pkgs[@]}; do
        nix-env -e "$pkg"
      done
      ;;
    "pacman")
      # shellcheck disable=SC2068
      $sudo_cmd pacman -R --noconfirm ${pkgs[@]}
      ;;
    "aur")
      # DO NOT use sudo with paru
      # shellcheck disable=SC2068
      paru -R --noconfirm ${pkgs[@]}
      ;;
    "yum")
      # shellcheck disable=SC2068
      $sudo_cmd yum remove -y ${pkgs[@]}
      ;;
    *)
      echo "ERROR: Uninstall not implemented for package manager: $pkg_mgr"
      exit 1
      ;;
  esac
}

main() {
  local pos_args=""

  # shellcheck disable=SC2086
  pkg_mgr="$(os-info --package-manager)"

  # disable usage of sudo if requested
  [[ "$DOTFILES_NO_SUDO" -eq 0 ]] && sudo_cmd="sudo " || sudo_cmd=""

  while (("$#")); do
    case "$1" in
      --type | -t)
        pkg_mgr="$2"
        shift 2
        ;;
      --skip-update | -s)
        SKIP_PACKAGE_MANAGER_UPDATE="true"
        shift 1
        ;;
      --no-sudo)
        DOTFILES_NO_SUDO=1
        sudo_cmd="sudo " || sudo_cmd=""
        shift 1
        ;;
      --) # end argument parsing
        shift
        break
        ;;
      *) # preserve positional arguments
        pos_args="$pos_args $1"
        shift
        ;;
    esac
  done

  # Set positional arguments in their proper place
  eval set -- "$pos_args"

  cmd="$1"
  [ -n "$cmd" ] && shift

  case "$cmd" in
    install | i)
      init_package_manager "$pkg_mgr"
      install_package "$@"
      ;;
    uninstall | u)
      init_package_manager "$pkg_mgr"
      uninstall_package "$@"
      ;;
    exec | x)
      init_package_manager "$pkg_mgr"
      exec "${@}"
      ;;
    help | --help | -h)
      usage
      ;;
    *)
      usage
      ;;
  esac
}

main "$@"
