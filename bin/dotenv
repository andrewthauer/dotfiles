#!/usr/bin/env bash
#
# Dotenv helpers & aliases
#
# usage:
#   dotenv [cmd] | [env_file]
#
# note:
#   On macOS `envsubst` requires gettext:
#     brew install gettext
#     brew link --force gettext
#

set -o errexit -o pipefail -o noclobber -o nounset

usage() {
  echo "Usage: dotenv [command]"
  echo "";
  echo "COMMANDS:";
  echo "  read       Reads the variables from a .env file";
  echo "  exec       Executes a command with the variables from the .env file";
  echo "  export     Exports the contents of a .env file to the current shells environment";
  echo "  subst      Substitutes environment variables in the specified file";
  echo "  help       Prints this message";
}

dotenv_read () {
  local file="${DOTENV_FILE:-${1:-.env}}"
  cat "${file}" | grep -v "^#" | grep -v -e "^$"
}

dotenv_exec() {
  env $(dotenv_read) ${@:1}
}

dotenv_export() {
  export $(dotenv_read ${1:-''} | xargs)
}

dotenv_subst() {
  if [[ ! -x "$(command -v envsubst)" ]]; then
    echo "Command 'envsubst' not found. Please install the 'gettext' package"
    exit 1
  fi

  dotenv_exec envsubst < "${1}"
}

main() {
  cmd=${1:-}
  args=${@:2}
  sub_cmd="dotenv_${cmd}"

  # Execute the command
  if [[ -x $(command -v $sub_cmd) ]]; then
    $sub_cmd $args 2>&1
  else
    if [[ -f ".env" ]]; then
      dotenv_read '.env'
    else
      usage
    fi
  fi
}

main $@
exit 0
