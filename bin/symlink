#!/usr/bin/env bash
#
# description:
#   Symlinks files & directories
#
# usage:
#   symlink path/to/source path/to/dest
#

set -e

expand_path() {
  eval path=$1
  echo $path
}

expand_source() {
  local src="$1"
  local filename=$(basename $src)
  local src_file="$(cd $(dirname $src); pwd)/$filename"
  echo "${src_file}"
}

expand_destination() {
  local src="$1"
  local dest="$2"

  # get sub directory
  local rel_dir="$(dirname ${src#./})"
  local top_dir="$(echo $rel_dir | cut -d "/" -f1)"
  local sub_dir="${rel_dir#$top_dir}"

  # the destination file
  local dest_file=
  if [ -n $dest ]; then
    dest_file="$(expand_path "$dest")"
  else
    dest_file="${base_dest_dir}${sub_dir}/${filename}"
  fi

  echo "${dest_file}"
}

symlink_item() {
  local src="$(expand_source "$1")"
  local dest="$(expand_destination "$1" "$2")"
  local dry_run="$3"

  echo "Symlinking: $src -> $dest"

  # Dry run
  if [[ -n "$dry_run" ]]; then
    return;
  fi

  # Remove existing symlinks
  if [[ -L "$dest" ]]; then
    rm $dest
  fi

  # Create new symlink
  if [[ ! -e "$src" ]]; then
    echo "Source does not exist - "$src""
  elif [[ -e "$dest" ]]; then
    echo "Destination file already exists - "$dest""
  else
    ln -s "$src" "$dest"
  fi
}

run() {
  local source=$1
  local target=$2
  symlink_item "$source" "$target" "$dry_run"
}

run $@;
