#!/usr/bin/env bash
#
# Set up a colocated Jujutsu repository in the current Git repository.
#

set -euo pipefail

check_dependencies() {
  command -v git >/dev/null 2>&1 || { echo "Error: git is not installed" >&2; exit 1; }
  command -v jj >/dev/null 2>&1 || { echo "Error: jj is not installed" >&2; exit 1; }
}

is_git_repo() {
  git rev-parse --git-dir &>/dev/null
}

get_git_root() {
  git rev-parse --show-toplevel
}

is_jj_initialized() {
  local git_root=$(get_git_root)
  [[ -d "$git_root/.jj" ]]
}

has_uncommitted_changes() {
  ! git diff --quiet || ! git diff --cached --quiet
}

has_remote_origin() {
  git remote get-url origin &>/dev/null
}

get_default_branch() {
  if has_remote_origin; then
    git symbolic-ref --short refs/remotes/origin/HEAD 2>/dev/null | sed 's@^origin/@@' || git branch --show-current
  else
    git branch --show-current
  fi
}

main() {
  check_dependencies

  if ! is_git_repo; then
    echo "Error: Not in a Git repository" >&2
    exit 1
  fi

  if is_jj_initialized; then
    echo "Repository is already initialized with Jujutsu" >&2
    exit 1
  fi

  if has_uncommitted_changes; then
    echo "Error: Repository has uncommitted changes" >&2
    exit 1
  fi

  local git_root=$(get_git_root)
  local git_email=$(git -C "$git_root" config user.email 2>/dev/null || true)
  if [[ -z "$git_email" ]]; then
    git_email=""
  fi

  if [[ -z "$git_email" ]]; then
    echo "Error: git user.email is not configured" >&2
    exit 1
  fi

  jj git init --colocate "$git_root"

  local remote="origin"
  if has_remote_origin; then
    local default_branch=$(get_default_branch)
    jj --repository "$git_root" bookmark track "${default_branch}@${remote}"
  fi

  jj --repository "$git_root" config set --repo user.email "$git_email"
  jj describe --reset-author --no-edit
}

main "$@"
